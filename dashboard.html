<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√§pyAI Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }
        @media (min-width: 500px) {
            .grid { grid-template-columns: 1fr 1fr; max-width: 600px; }
        }
        .card {
            background: #14141a;
            border-radius: 12px;
            padding: 14px;
            border: 1px solid #252530;
        }
        .card h3 {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
        }
        .big { font-size: 32px; font-weight: bold; }
        .medium { font-size: 18px; }
        .small { font-size: 12px; color: #888; }
        .row { display: flex; align-items: center; gap: 10px; }
        .col { display: flex; flex-direction: column; gap: 3px; }
        .good { color: #4ade80; }
        .warn { color: #fbbf24; }
        .bad { color: #f87171; }
        .muted { color: #666; }
        .loading { color: #666; font-style: italic; }
        .chart {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 50px;
            margin-top: 8px;
        }
        .bar {
            flex: 1;
            background: #3b82f6;
            border-radius: 2px 2px 0 0;
            min-height: 4px;
            transition: height 0.3s;
        }
        .bar.current { background: #fbbf24; }
        .bar.good { background: #4ade80; }
        .bar.bad { background: #f87171; }
        .bar-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #666;
            margin-top: 4px;
        }
        .timestamp {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
        .bar-container {
            margin-top: 10px;
        }
        .bar-bg {
            background: #252530;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #fbbf24, #f87171);
            transition: width 0.5s;
        }
        #status { font-size: 10px; }
        .fingrid-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #252530;
            font-size: 12px;
        }
        .fingrid-row:last-child { border-bottom: none; }
        .fingrid-val { font-weight: bold; }
        .production { color: #60a5fa; }
        .consumption { color: #fbbf24; }
    </style>
</head>
<body>
    <div class="grid">
        <!-- Energy -->
        <div class="card">
            <h3>‚ö° Energy <span id="energy-status" class="loading">...</span></h3>
            <div class="row">
                <span class="big" id="energy-current">--</span>
            </div>
            <div class="row" style="margin-top: 8px; gap: 12px;">
                <span class="small" id="energy-min">Min: --</span>
                <span class="small" id="energy-max">Max: --</span>
            </div>
            <div class="chart" id="energy-chart"></div>
            <div class="bar-labels"><span>00</span><span>06</span><span>12</span><span>18</span><span>23</span></div>
        </div>

        <!-- Weather -->
        <div class="card">
            <h3>üå§Ô∏è Helsinki <span id="weather-status" class="loading">...</span></h3>
            <div class="row" style="margin-bottom: 10px;">
                <span style="font-size: 42px;" id="weather-icon">üå°Ô∏è</span>
                <div class="col">
                    <span class="big" id="weather-temp">--¬∞</span>
                    <span class="small" id="weather-wind">Wind: -- m/s</span>
                </div>
            </div>
            <div class="small muted" id="weather-feels">Feels like: --¬∞C</div>
        </div>

        <!-- Fingrid Grid -->
        <div class="card" style="grid-column: span 1;">
            <h3>‚ö° Finnish Grid <span id="fingrid-status" class="loading">...</span></h3>
            <div class="fingrid-row">
                <span>Production</span>
                <span class="fingrid-val production" id="fingrid-prod">-- MW</span>
            </div>
            <div class="fingrid-row">
                <span>Consumption</span>
                <span class="fingrid-val consumption" id="fingrid-cons">-- MW</span>
            </div>
            <div class="fingrid-row">
                <span>Balance</span>
                <span class="fingrid-val" id="fingrid-balance">-- MW</span>
            </div>
            <div class="small muted" style="margin-top: 8px; font-size: 10px;">Real-time data from Fingrid (3 min)</div>
        </div>
    </div>

    <div class="card" style="max-width: 400px; margin: 10px auto;">
        <h3></h3>
        <div class="bar-container">
            <div class="bar-bg"><div class="bar-fill" id="stat-bar" style="width: 0%"></div></div>
        </div>
    </div>

    <div class="timestamp" id="last-update">Loading...</div>

    <script>
        const HELSINKI_LAT = 60.1699;
        const HELSINKI_LON = 24.9384;
        const CORS_PROXY = 'https://corsproxy.io/?';

        function getWeatherEmoji(code) {
            const codes = {
                0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
                45: 'üå´Ô∏è', 48: 'üå´Ô∏è', 51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è',
                61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
                71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è', 95: '‚õàÔ∏è'
            };
            return codes[code] || 'üå°Ô∏è';
        }

        function getHelsinkiHour() {
            return new Date().toLocaleString('en-US', {
                hour: '2-digit', hour12: false, timeZone: 'Europe/Helsinki'
            });
        }

        async function fetchElectricity() {
            try {
                const now = new Date();
                const start = new Date(now); start.setHours(0, 0, 0, 0);
                const end = new Date(now); end.setHours(23, 59, 59, 999);
                
                const url = `${CORS_PROXY}https://dashboard.elering.ee/api/nps/price?start=${start.toISOString()}&end=${end.toISOString()}&fields=fi`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed');
                
                const data = await response.json();
                const prices = data.data?.fi || [];
                const currentHour = parseInt(getHelsinkiHour());
                
                let currentPrice = null;
                const hourlyPrices = [];
                
                for (const p of prices) {
                    const hour = new Date(p.timestamp * 1000).toLocaleString('en-US', {
                        hour: '2-digit', hour12: false, timeZone: 'Europe/Helsinki'
                    });
                    const priceCents = p.price / 10;
                    hourlyPrices.push({ hour: parseInt(hour), price: priceCents });
                    if (parseInt(hour) === currentHour) currentPrice = priceCents;
                }
                
                const pricesOnly = hourlyPrices.map(p => p.price);
                const min = Math.min(...pricesOnly);
                const max = Math.max(...pricesOnly);
                
                return { currentPrice, hourlyPrices, min, max };
            } catch (e) {
                return { error: e.message };
            }
        }

        async function fetchWeather() {
            try {
                const url = `${CORS_PROXY}https://api.open-meteo.com/v1/forecast?latitude=${HELSINKI_LAT}&longitude=${HELSINKI_LON}&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m&timezone=Europe/Helsinki`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed');
                return await response.json();
            } catch (e) {
                return { error: e.message };
            }
        }

        async function fetchFingrid() {
            try {
                // Dataset 192 = Production, 193 = Consumption
                const now = new Date();
                const start = new Date(now.getTime() - 10 * 60 * 1000); // 10 min ago
                const end = now;
                
                const prodUrl = `${CORS_PROXY}https://api.fingrid.fi/v1/variable/192/events/json?start_time=${start.toISOString()}&end_time=${end.toISOString()}`;
                const consUrl = `${CORS_PROXY}https://api.fingrid.fi/v1/variable/193/events/json?start_time=${start.toISOString()}&end_time=${end.toISOString()}`;
                
                const [prodRes, consRes] = await Promise.all([
                    fetch(prodUrl),
                    fetch(consUrl)
                ]);
                
                if (!prodRes.ok || !consRes.ok) throw new Error('API failed');
                
                const prodData = await prodRes.json();
                const consData = await consRes.json();
                
                // Get latest values
                const production = prodData[prodData.length - 1]?.value || 0;
                const consumption = consData[consData.length - 1]?.value || 0;
                
                return { production, consumption, balance: production - consumption };
            } catch (e) {
                return { error: e.message };
            }
        }

        function renderEnergy(data) {
            if (data.error) {
                document.getElementById('energy-status').textContent = '‚ùå';
                document.getElementById('energy-current').textContent = 'Err';
                return;
            }
            
            // Add VAT (25.5%) to match consumer prices
            const VAT_MULTIPLIER = 1.255;
            const currentPrice = (data.currentPrice || 0) * VAT_MULTIPLIER;
            const min = data.min * VAT_MULTIPLIER;
            const max = data.max * VAT_MULTIPLIER;
            const hourlyPrices = data.hourlyPrices.map(p => ({...p, price: p.price * VAT_MULTIPLIER}));
            
            document.getElementById('energy-status').textContent = '‚úì';
            document.getElementById('energy-current').textContent = currentPrice.toFixed(2).replace('.', ',') + 'snt/kWh';
            document.getElementById('energy-current').className = 'big ' + (currentPrice < 6 ? 'good' : currentPrice > 15 ? 'bad' : 'warn');
            document.getElementById('energy-min').textContent = `Min: ${min.toFixed(2).replace('.', ',')}snt`;
            document.getElementById('energy-min').className = 'small good';
            document.getElementById('energy-max').textContent = `Max: ${max.toFixed(2).replace('.', ',')}snt`;
            
            // Chart
            const chart = document.getElementById('energy-chart');
            chart.innerHTML = '';
            const currentHour = parseInt(getHelsinkiHour());
            
            for (let i = 0; i < 24; i++) {
                const hourData = hourlyPrices.find(p => p.hour === i);
                if (!hourData) continue;
                
                const bar = document.createElement('div');
                const height = ((hourData.price - min) / (max - min || 1)) * 100;
                bar.style.height = Math.max(4, height) + '%';
                bar.className = 'bar' + (i === currentHour ? ' current' : '');
                if (hourData.price < 6) bar.classList.add('good');
                if (hourData.price > 15) bar.classList.add('bad');
                chart.appendChild(bar);
            }
        }

        function renderWeather(data) {
            if (data.error) {
                document.getElementById('weather-status').textContent = '‚ùå';
                return;
            }

            const c = data.current;
            document.getElementById('weather-status').textContent = '‚úì';
            document.getElementById('weather-icon').textContent = getWeatherEmoji(c.weather_code);
            document.getElementById('weather-temp').textContent = Math.round(c.temperature_2m) + '¬∞';
            document.getElementById('weather-wind').textContent = `Wind: ${c.wind_speed_10m} m/s`;
            document.getElementById('weather-feels').textContent = `Feels like: ${Math.round(c.apparent_temperature)}¬∞C`;
        }

        function renderFingrid(data) {
            if (data.error) {
                document.getElementById('fingrid-status').textContent = '‚ùå';
                return;
            }

            document.getElementById('fingrid-status').textContent = '‚úì';
            document.getElementById('fingrid-prod').textContent = Math.round(data.production) + ' MW';
            document.getElementById('fingrid-cons').textContent = Math.round(data.consumption) + ' MW';

            const balanceEl = document.getElementById('fingrid-balance');
            const balance = data.balance;
            balanceEl.textContent = (balance > 0 ? '+' : '') + Math.round(balance) + ' MW';
            balanceEl.className = 'fingrid-val ' + (balance > 0 ? 'production' : 'consumption');
        }

        async function loadAll() {
            document.getElementById('last-update').textContent = 'Updating...';

            const [energy, weather, fingrid] = await Promise.all([fetchElectricity(), fetchWeather(), fetchFingrid()]);

            renderEnergy(energy);
            renderWeather(weather);
            renderFingrid(fingrid);

            const now = new Date();
            document.getElementById('last-update').textContent =
                `Updated: ${now.toLocaleTimeString('fi-FI', {hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Helsinki'})} (Helsinki)`;
        }

        async function loadStat() {
            try {
                const r = await fetch('api/s.json');
                const d = await r.json();
                document.getElementById('stat-bar').style.width = d.v + '%';
            } catch(e) {}
        }

        // Initial load
        loadAll();
        loadStat();
        
        // Refresh every 5 minutes
        setInterval(loadAll, 5 * 60 * 1000);
        setInterval(loadStat, 30000);
    </script>
</body>
</html>
